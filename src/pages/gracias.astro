---
export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import Card from '../components/ui/Card.astro';
import ThankYouContent from '../components/sales/ThankYouContent.tsx';
import SocialShareButtons from '../components/ui/SocialShareButtons.tsx';
import { accessSteps, thankYouHeading, thankYouMessage } from '../data/thank-you-data';
import { getStripe } from '../lib/stripe';

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://example.com';

// Validate session_id server-side
const sessionId = Astro.url.searchParams.get('session_id');
const hasUpsellParam = Astro.url.searchParams.get('upsell') === '1';

if (!sessionId) {
  return Astro.redirect('/');
}

let amountPaid = 0;
let lineItems: { description: string; amount: number; quantity: number }[] = [];
let showUpsell = false;

try {
  const stripe = getStripe();
  const session = await stripe.checkout.sessions.retrieve(sessionId, {
    expand: ['line_items'],
  });

  if (session.payment_status !== 'paid') {
    return Astro.redirect('/');
  }

  amountPaid = (session.amount_total ?? 0) / 100;

  if (session.line_items?.data) {
    lineItems = session.line_items.data.map((item) => ({
      description: item.description ?? 'Producto',
      amount: (item.amount_total ?? 0) / 100,
      quantity: item.quantity ?? 1,
    }));
  }

  // Show upsell if this was the main purchase (not already an upsell) and upsell not yet purchased
  showUpsell = !hasUpsellParam && session.metadata?.type !== 'upsell';
} catch {
  return Astro.redirect('/');
}
---

<BaseLayout
  title="¡Compra confirmada! | Pack de 275+ Prompts IA"
  description="Tu compra ha sido confirmada. Sigue estos pasos para acceder a tus 275+ prompts de IA."
  noindex={true}
  canonicalPath="/gracias"
>
  <div class="py-12 md:py-20 px-4">
    <div class="max-w-2xl mx-auto text-center">
      <!-- Success checkmark -->
      <div class="mb-6">
        <div class="w-20 h-20 mx-auto bg-success/20 rounded-full flex items-center justify-center">
          <svg class="w-10 h-10 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
        </div>
      </div>

      <h1 class="text-3xl md:text-4xl font-bold mb-4">{thankYouHeading}</h1>
      <p class="text-text-secondary text-lg mb-10">{thankYouMessage}</p>

      <!-- Order summary + upsell (Preact island) -->
      <div class="mb-10">
        <ThankYouContent
          client:load
          lineItems={lineItems}
          amountPaid={amountPaid}
          showUpsell={showUpsell}
          sessionId={sessionId}
          hasUpsell={hasUpsellParam}
        />
      </div>

      <!-- 3-step access guide -->
      <div class="space-y-4 mb-12 text-left">
        {accessSteps.map((step) => (
          <Card>
            <div class="flex gap-4 items-start">
              <div class="flex-shrink-0 w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary-light font-bold">
                {step.step}
              </div>
              <div>
                <h3 class="font-semibold text-text-primary">{step.title}</h3>
                <p class="text-text-secondary text-sm mt-1">{step.description}</p>
              </div>
            </div>
          </Card>
        ))}
      </div>

      <!-- Social sharing -->
      <div class="mb-10">
        <h2 class="text-xl font-semibold mb-4">Comparte con tus colegas</h2>
        <p class="text-text-secondary text-sm mb-6">
          ¿Conoces a alguien que también se beneficiaría de estos prompts?
        </p>
        <SocialShareButtons shareUrl={siteUrl} client:load />
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline define:vars={{ sessionId, amountPaid, hasUpsell: hasUpsellParam }}>
  window.__purchaseData = { sessionId, amountPaid, hasUpsell };
</script>

<script>
  import { trackEvent, initDataLayer } from '../lib/analytics';
  import { captureUTMParams } from '../lib/tracking';
  import { getConsentState, loadGTM } from '../lib/cookie-consent';

  initDataLayer();
  captureUTMParams();

  const consent = getConsentState();
  if (consent?.analytics) {
    loadGTM();
  }

  // Fire purchase event with server-validated data
  const data = (window as unknown as { __purchaseData: { sessionId: string; amountPaid: number; hasUpsell: boolean } }).__purchaseData;
  trackEvent({
    name: 'purchase_confirmed',
    params: {
      page: '/gracias',
      has_bump: false,
      has_upsell: data.hasUpsell,
      transaction_id: data.sessionId,
      value: data.amountPaid,
      currency: 'EUR',
    },
  });

  // Confetti (single-fire, respects prefers-reduced-motion)
  async function fireConfetti() {
    if (sessionStorage.getItem('confetti_fired')) return;
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    try {
      const { default: confetti } = await import('canvas-confetti');
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 },
      });
      sessionStorage.setItem('confetti_fired', '1');
    } catch {
      // canvas-confetti not available — page still works fine
    }
  }
  fireConfetti();
</script>
